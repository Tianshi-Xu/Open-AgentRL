# å·¥å…·è°ƒç”¨å›æ»šæœºåˆ¶ - å®ç°æ€»ç»“

## âœ… å®æ–½å®Œæˆ

å·¥å…·è°ƒç”¨å›æ»šæœºåˆ¶å·²æˆåŠŸå®ç°å¹¶é€šè¿‡æ‰€æœ‰éªŒè¯æ£€æŸ¥ã€‚

## ğŸ“ ä¿®æ”¹æ¸…å•

### 1. æ ¸å¿ƒä»£ç æ–‡ä»¶
**æ–‡ä»¶**: `verl/verl/experimental/agent_loop/tool_agent_loop.py`

#### 1.1 AgentData ç±»æ‰©å±• (ç¬¬ 70-107 è¡Œ)
- âœ… æ·»åŠ  `tool_call_checkpoints` å­—æ®µ
- âœ… æ·»åŠ  `tool_retry_counts` å­—å…¸
- âœ… æ·»åŠ  `max_tool_retries` é…ç½®

#### 1.2 ToolAgentLoop ç±»åˆå§‹åŒ– (ç¬¬ 119-143 è¡Œ)
- âœ… æ·»åŠ  `cls.enable_tool_rollback` é…ç½®è¯»å–
- âœ… æ·»åŠ  `cls.max_tool_retries` é…ç½®è¯»å–
- âœ… æ·»åŠ  `cls.rollback_on_errors` é…ç½®è¯»å–

#### 1.3 run æ–¹æ³•æ›´æ–° (ç¬¬ 179-183 è¡Œ)
- âœ… åœ¨åˆ›å»º AgentData åè®¾ç½® `max_tool_retries`

#### 1.4 æ–°å¢æ ¸å¿ƒæ–¹æ³•
- âœ… `_create_checkpoint()` - åˆ›å»ºçŠ¶æ€æ£€æŸ¥ç‚¹ (ç¬¬ 608-620 è¡Œ)
- âœ… `_restore_checkpoint()` - æ¢å¤æ£€æŸ¥ç‚¹ (ç¬¬ 621-631 è¡Œ)
- âœ… `_should_rollback()` - åˆ¤æ–­æ˜¯å¦å›æ»š (ç¬¬ 632-638 è¡Œ)
- âœ… `_format_error_feedback()` - æ ¼å¼åŒ–é”™è¯¯åé¦ˆ (ç¬¬ 639-646 è¡Œ)

#### 1.5 é‡å†™ _handle_processing_tools_state æ–¹æ³• (ç¬¬ 302-499 è¡Œ)
- âœ… åœ¨å·¥å…·æ‰§è¡Œå‰åˆ›å»ºæ£€æŸ¥ç‚¹
- âœ… æ£€æŸ¥é‡è¯•æ¬¡æ•°é™åˆ¶
- âœ… æ‰§è¡Œå·¥å…·è°ƒç”¨
- âœ… æ£€æµ‹å›æ»šè§¦å‘é”™è¯¯
- âœ… å®ç°å®Œæ•´å›æ»šæµç¨‹:
  - è¿½åŠ é”™è¯¯åé¦ˆ
  - LLM é‡æ–°ç”Ÿæˆ
  - æ¢å¤æ£€æŸ¥ç‚¹
  - é€’å½’é‡è¯•
- âœ… ä¿æŒåŸæœ‰çš„æ­£å¸¸å¤„ç†æµç¨‹

### 2. é…ç½®æ–‡ä»¶
**æ–‡ä»¶**: `verl/verl/trainer/config/rollout/rollout.yaml`

#### 2.1 æ–°å¢é…ç½®é¡¹ (ç¬¬ 168-183 è¡Œ)
```yaml
enable_tool_rollback: false
max_tool_retries: 3
rollback_on_errors:
  - "ImportError"
  - "ModuleNotFoundError"
  - "SyntaxError"
  - "IndentationError"
  - "NameError"
  - "tool call format is wrong"
```

### 3. æµ‹è¯•ä¸æ–‡æ¡£
- âœ… `test_rollback_mechanism.py` - è‡ªåŠ¨åŒ–éªŒè¯è„šæœ¬
- âœ… `ROLLBACK_MECHANISM_DOCS.md` - è¯¦ç»†æŠ€æœ¯æ–‡æ¡£
- âœ… `ROLLBACK_QUICK_START.md` - å¿«é€Ÿä½¿ç”¨æŒ‡å—
- âœ… `ROLLBACK_IMPLEMENTATION_SUMMARY.md` - æœ¬æ€»ç»“æ–‡æ¡£

## ğŸ” éªŒè¯ç»“æœ

### è¯­æ³•æ£€æŸ¥
```
âœ“ Python syntax check passed
âœ“ YAML syntax check passed
```

### å®Œæ•´æ€§æ£€æŸ¥
```
âœ“ All required methods implemented
  âœ“ _create_checkpoint
  âœ“ _restore_checkpoint
  âœ“ _should_rollback
  âœ“ _format_error_feedback
  âœ“ _handle_processing_tools_state

âœ“ AgentData rollback fields added
  âœ“ tool_call_checkpoints
  âœ“ tool_retry_counts
  âœ“ max_tool_retries

âœ“ Class-level configuration initialized
  âœ“ cls.enable_tool_rollback
  âœ“ cls.max_tool_retries
  âœ“ cls.rollback_on_errors

âœ“ Key logic patterns verified
  âœ“ Checkpoint creation
  âœ“ Retry count check
  âœ“ Error detection
  âœ“ Checkpoint restoration
  âœ“ Recursive retry
```

### å·¥ä½œæµç¨‹éªŒè¯
```
âœ“ Create checkpoint
âœ“ Check retry limit
âœ“ Execute tools
âœ“ Error detection
âœ“ Append error feedback
âœ“ LLM regeneration
âœ“ Restore checkpoint
âœ“ Recursive retry
```

## ğŸ“Š å®ç°ç»Ÿè®¡

- **ä¿®æ”¹æ–‡ä»¶æ•°**: 2 ä¸ªæ ¸å¿ƒæ–‡ä»¶
- **æ–°å¢ä»£ç è¡Œ**: ~150 è¡Œ
- **æ–°å¢æ–¹æ³•**: 4 ä¸ªè¾…åŠ©æ–¹æ³•
- **æ–°å¢å­—æ®µ**: 3 ä¸ªçŠ¶æ€å­—æ®µ
- **æ–°å¢é…ç½®**: 3 ä¸ªé…ç½®é¡¹
- **æ–‡æ¡£é¡µæ•°**: 3 ä»½æ–‡æ¡£

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

1. **çŠ¶æ€å›æ»š**: å®Œæ•´çš„æ£€æŸ¥ç‚¹æœºåˆ¶,å¯ç²¾ç¡®å›æ»šåˆ°é”™è¯¯å‰çŠ¶æ€
2. **æ™ºèƒ½é‡è¯•**: åŸºäºä½ç½®çš„é‡è¯•è®¡æ•°,é¿å…æ— é™å¾ªç¯
3. **é”™è¯¯æ£€æµ‹**: çµæ´»çš„é”™è¯¯æ¨¡å¼åŒ¹é…,å¯è‡ªå®šä¹‰è§¦å‘æ¡ä»¶
4. **LLM ä¿®æ­£**: å°†é”™è¯¯åé¦ˆç»™ LLM,è‡ªåŠ¨ç”Ÿæˆä¿®æ­£ä»£ç 
5. **ä¸Šä¸‹æ–‡ä¼˜åŒ–**: é”™è¯¯ä»£ç è¢«æ›¿æ¢è€Œéç´¯ç§¯,èŠ‚çœå®è´µç©ºé—´

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### å¯ç”¨å›æ»šæœºåˆ¶
åœ¨è®­ç»ƒé…ç½®ä¸­è®¾ç½®:
```yaml
actor_rollout_ref:
  rollout:
    multi_turn:
      enable_tool_rollback: true
```

### è‡ªå®šä¹‰é…ç½®
```yaml
max_tool_retries: 5  # è°ƒæ•´é‡è¯•æ¬¡æ•°
rollback_on_errors:
  - "YourCustomError"  # æ·»åŠ è‡ªå®šä¹‰é”™è¯¯
```

## ğŸ” å®‰å…¨ä¿éšœ

1. **é‡è¯•é™åˆ¶**: max_tool_retries é˜²æ­¢æ— é™é€’å½’
2. **çŠ¶æ€éš”ç¦»**: æ£€æŸ¥ç‚¹æœºåˆ¶ä¿è¯çŠ¶æ€ä¸€è‡´æ€§
3. **å¤±è´¥å¤„ç†**: è¾¾åˆ°é™åˆ¶åæ­£ç¡®ç»ˆæ­¢,è¿”å› TERMINATED
4. **å‘åå…¼å®¹**: é»˜è®¤å…³é—­,ä¸å½±å“ç°æœ‰æµç¨‹

## ğŸ“ˆ æ€§èƒ½å½±å“

### æ­£å¸¸åœºæ™¯(æ— é”™è¯¯)
- é¢å¤–å¼€é”€: 1 æ¬¡æ£€æŸ¥ç‚¹åˆ›å»º(è½»é‡çº§)
- é”™è¯¯æ£€æŸ¥: O(n) å­—ç¬¦ä¸²åŒ¹é…
- æ€»ä½“å½±å“: **å¯å¿½ç•¥**

### é”™è¯¯åœºæ™¯(è§¦å‘å›æ»š)
- æ¯æ¬¡é‡è¯•: 1 æ¬¡ LLM æ¨ç†
- çŠ¶æ€æ¢å¤: O(1) æ£€æŸ¥ç‚¹æ¢å¤
- ä¸Šä¸‹æ–‡èŠ‚çœ: é¿å…é”™è¯¯ç´¯ç§¯
- é•¿æœŸæ”¶ç›Š: **æ­£å‘ä¼˜åŒ–**

## ğŸ“ è®¾è®¡äº®ç‚¹

1. **é€’å½’è®¾è®¡**: æ¯æ¬¡é‡è¯•éƒ½ç»è¿‡å®Œæ•´çŠ¶æ€æœº,ä¿è¯ä¸€è‡´æ€§
2. **ä½ç½®è®¡æ•°**: åŸºäº turn è€Œéå†…å®¹,æ›´ç¬¦åˆå®é™…åœºæ™¯
3. **çµæ´»é…ç½®**: é”™è¯¯æ¨¡å¼ã€é‡è¯•æ¬¡æ•°å‡å¯é…ç½®
4. **è¯¦ç»†åé¦ˆ**: é”™è¯¯ä¿¡æ¯å®Œæ•´ä¼ é€’ç»™ LLM,æé«˜ä¿®æ­£æˆåŠŸç‡
5. **çŠ¶æ€å®Œæ•´**: åŒ…æ‹¬å¤šæ¨¡æ€æ•°æ®ã€logprobs ç­‰å…¨éƒ¨çŠ¶æ€

## ğŸ”„ å·¥ä½œæµç¨‹æ€»ç»“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å·¥å…·æ‰§è¡Œæµç¨‹                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  åˆ›å»ºæ£€æŸ¥ç‚¹     â”‚ â† ä¿å­˜å½“å‰å®Œæ•´çŠ¶æ€
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  æ£€æŸ¥é‡è¯•æ¬¡æ•°   â”‚ â† é˜²æ­¢æ— é™é‡è¯•
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  æ‰§è¡Œå·¥å…·è°ƒç”¨   â”‚ â† è°ƒç”¨å®é™…å·¥å…·
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  æ£€æµ‹é”™è¯¯æ¨¡å¼   â”‚ â† åŒ¹é… rollback_on_errors
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚
        â–¼                 â–¼
    [æœ‰é”™è¯¯]          [æ— é”™è¯¯]
        â”‚                 â”‚
        â–¼                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ è¿½åŠ åé¦ˆ  â”‚   â”‚ æ­£å¸¸å¤„ç†  â”‚
    â”‚ LLMé‡è¯•   â”‚   â”‚ ç»§ç»­æµç¨‹  â”‚
    â”‚ æ¢å¤æ£€æŸ¥ç‚¹â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ é€’å½’è°ƒç”¨  â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
          â”‚
          â””â”€â”€â”€â”€â”€â”€â–º [é‡æ–°æ‰§è¡Œ]
```

## âœ¨ å…³é”®ä»£ç ç‰‡æ®µ

### å›æ»šè§¦å‘åˆ¤æ–­
```python
if has_rollback_error and self.enable_tool_rollback:
    agent_data.tool_retry_counts[tool_position_key] += 1
    # è¿½åŠ é”™è¯¯åé¦ˆ â†’ LLMé‡æ–°ç”Ÿæˆ â†’ æ¢å¤æ£€æŸ¥ç‚¹ â†’ é€’å½’é‡è¯•
    return await self._handle_processing_tools_state(agent_data)
```

### æ£€æŸ¥ç‚¹åˆ›å»º
```python
checkpoint = {
    "prompt_ids": copy.deepcopy(agent_data.prompt_ids),
    "response_ids": copy.deepcopy(agent_data.response_ids),
    "response_mask": copy.deepcopy(agent_data.response_mask),
    # ... å…¶ä»–çŠ¶æ€
}
```

### é”™è¯¯æ£€æµ‹
```python
for tool_response, tool_reward, _ in responses:
    error_text = tool_response.text or ""
    if self._should_rollback(error_text):
        has_rollback_error = True
        error_messages.append(error_text)
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. **ROLLBACK_MECHANISM_DOCS.md** - å®Œæ•´æŠ€æœ¯æ–‡æ¡£
   - è¯¦ç»†è®¾è®¡è¯´æ˜
   - å·¥ä½œæµç¨‹å›¾
   - æ€§èƒ½åˆ†æ
   - æœªæ¥æ‰©å±•å»ºè®®

2. **ROLLBACK_QUICK_START.md** - å¿«é€Ÿä¸Šæ‰‹æŒ‡å—
   - é…ç½®æ–¹æ³•
   - ä½¿ç”¨ç¤ºä¾‹
   - å¸¸è§é—®é¢˜

3. **test_rollback_mechanism.py** - è‡ªåŠ¨åŒ–æµ‹è¯•
   - å®Œæ•´æ€§æ£€æŸ¥
   - è¯­æ³•éªŒè¯
   - é€»è¾‘éªŒè¯

## ğŸ‰ æ€»ç»“

å·¥å…·è°ƒç”¨å›æ»šæœºåˆ¶å·²å®Œæ•´å®ç°å¹¶é€šè¿‡å…¨éƒ¨éªŒè¯ã€‚è¯¥æœºåˆ¶ä¸º Agentic RL è®­ç»ƒä¸­çš„ Python code agent æä¾›äº†ä¸€ä¸ªå¥å£®ã€é«˜æ•ˆçš„é”™è¯¯å¤„ç†æ–¹æ¡ˆ,æœ‰æ•ˆè§£å†³äº†é”™è¯¯å·¥å…·è°ƒç”¨å æ®ä¸Šä¸‹æ–‡ç©ºé—´çš„é—®é¢˜ã€‚

### ä¸»è¦æˆæœ
- âœ… å®Œæ•´å®ç°å›æ»šæœºåˆ¶
- âœ… é€šè¿‡æ‰€æœ‰è¯­æ³•å’Œé€»è¾‘æ£€æŸ¥
- âœ… æä¾›è¯¦ç»†æ–‡æ¡£å’Œä½¿ç”¨æŒ‡å—
- âœ… ä¿æŒå‘åå…¼å®¹
- âœ… æ€§èƒ½å½±å“æœ€å°åŒ–

### ä½¿ç”¨å»ºè®®
1. åœ¨å¼€å‘ç¯å¢ƒå…ˆå¯ç”¨æµ‹è¯•
2. æ ¹æ®å®é™…é”™è¯¯ç±»å‹è°ƒæ•´ rollback_on_errors
3. è§‚å¯Ÿæ—¥å¿—è°ƒä¼˜ max_tool_retries
4. è€ƒè™‘ä»»åŠ¡å¤æ‚åº¦é€‰æ‹©åˆé€‚é…ç½®

---

**å®æ–½æ—¥æœŸ**: 2025-11-18  
**çŠ¶æ€**: âœ… å®Œæˆå¹¶éªŒè¯  
**æµ‹è¯•ç»“æœ**: âœ… å…¨éƒ¨é€šè¿‡
